---
title: "R Notebook"
output: html_notebook
---

Trend analysis of leatherback turtles nesting in Florida, Puerto Rico, and St Croix with Kelly Stewart.

```{r}
rm(list=ls())
library(tidyverse)
library(ggplot2)
library(readr)
library(lubridate)
library(jagsUI)
library(bayesplot)
```

Get data;

```{r}
col.def <- cols(ID = col_integer(),
                year = col_integer(),
                beach = col_character(),
                latitude = col_double(),
                distance = col_double(),
                days_week = col_integer(),
                days_year = col_integer(),
                nests = col_integer())

nest.counts <- read_csv("data/FL_PR_STX.csv", col_types = col.def) %>% 
  mutate(lat_band = ifelse(latitude < 26, 25,
                           ifelse(latitude < 27, 26,
                                  ifelse(latitude < 28, 27,
                                         ifelse(latitude < 29, 28,
                                                ifelse(latitude < 30, 29,
                                                       ifelse(latitude < 31, 30)))))),
         beach_f = as.factor(toupper(beach)))

```


See what they look like:

```{r}
ggplot(data = nest.counts) +
  geom_point(aes(x = year, y = log(nests+1),
                 color = as.factor(ID))) +
  geom_line(aes(x = year, y = log(nests + 1),
                color = as.factor(ID),
                group = as.factor(ID))) +
  
  facet_wrap( ~ lat_band, nrow = 3) +
  theme(legend.position = "none")
```

Plot each beach grouped by latitude band

```{r}
nest.counts %>% filter(lat_band == 25) -> nest.counts.25
ggplot(data = nest.counts.25) +
  geom_point(aes(x = year, y = log(nests+1))) +
  geom_line(aes(x = year, y = log(nests + 1))) +
  facet_wrap( ~ factor(ID)) +
  theme(legend.position = "none") + 
  labs(title = "Latitude 25")
```

Too many beaches here so split them into 3 groups.

```{r}
nest.counts %>% filter(lat_band == 26) -> nest.counts.26
unique.IDs <- unique(nest.counts.26$ID)
first.10 <- unique.IDs[1:10]
nest.counts.26 %>% filter(ID %in% first.10) -> nest.counts.26.1

ggplot(data = nest.counts.26.1) +
  geom_point(aes(x = year, y = log(nests+1))) +
  geom_line(aes(x = year, y = log(nests + 1))) +
  facet_wrap( ~ factor(ID), ncol = 3) +
  theme(legend.position = "none") + 
  labs(title = "Latitude 26")
```

```{r}
second.10 <- unique.IDs[11:20]
nest.counts.26 %>% filter(ID %in% second.10) -> nest.counts.26.2

ggplot(data = nest.counts.26.2) +
  geom_point(aes(x = year, y = log(nests+1))) +
  geom_line(aes(x = year, y = log(nests + 1))) +
  facet_wrap( ~ factor(ID), ncol = 3) +
  theme(legend.position = "none") + 
  labs(title = "Latitude 26")
```

```{r}
beaches.21.31 <- unique.IDs[21:31]
nest.counts.26 %>% filter(ID %in% beaches.21.31) -> nest.counts.26.3

ggplot(data = nest.counts.26.3) +
  geom_point(aes(x = year, y = log(nests+1))) +
  geom_line(aes(x = year, y = log(nests + 1))) +
  facet_wrap( ~ factor(ID), ncol = 3) +
  theme(legend.position = "none") + 
  labs(title = "Latitude 26")
```


```{r}
nest.counts %>% filter(lat_band == 27) -> nest.counts.27
ggplot(data = nest.counts.27) +
  geom_point(aes(x = year, y = log(nests+1))) +
  geom_line(aes(x = year, y = log(nests + 1))) +
  facet_wrap( ~ factor(ID), ncol = 3) +
  theme(legend.position = "none") + 
  labs(title = "Latitude 27")
```


```{r}
nest.counts %>% filter(lat_band == 28) -> nest.counts.28
ggplot(data = nest.counts.28) +
  geom_point(aes(x = year, y = log(nests+1))) +
  geom_line(aes(x = year, y = log(nests + 1))) +
  facet_wrap( ~ factor(ID), ncol = 3) +
  theme(legend.position = "none") + 
  labs(title = "Latitude 28")
```


```{r}
nest.counts %>% filter(lat_band == 29) -> nest.counts.29
ggplot(data = nest.counts.29) +
  geom_point(aes(x = year, y = log(nests+1))) +
  geom_line(aes(x = year, y = log(nests + 1))) +
  facet_wrap( ~ factor(ID), ncol = 3) +
  theme(legend.position = "none") + 
  labs(title = "Latitude 29")
```


```{r}
nest.counts %>% filter(lat_band == 30) -> nest.counts.30
ggplot(data = nest.counts.30) +
  geom_point(aes(x = year, y = log(nests+1))) +
  geom_line(aes(x = year, y = log(nests + 1))) +
  facet_wrap( ~ factor(ID), ncol = 3) +
  theme(legend.position = "none") + 
  labs(title = "Latitude 30")
```

Time series are different lengths. 

```{r}
nest.counts %>% group_by(ID) %>%
  summarise(n = length(year),
            latitude = first(latitude),
            distance = first(distance),
            lat_band = first(lat_band)) -> nest.counts.n

ggplot(data = nest.counts.n) + 
  geom_point(aes(x = lat_band, y = n))
```


Try fitting growth models - we can use the same model as the last paper first. 

```{r}
X <- cbind(nest.counts$distance - median(nest.counts$distance),
           nest.counts$days_week - median(nest.counts$days_week),
           nest.counts$days_year - median(nest.counts$days_year))

nest.counts %>% select(ID, latitude) %>% group_by(ID) %>%
  summarise(latitude = first(latitude)) %>%
  mutate(latc = latitude - mean(latitude),
         latc2 = latc^2) -> lat.dat 

#min(nest.counts$year):max(nest.counts$year)

jags.data <- list(N = length(nest.counts$nests),
                  nbeach = nrow(lat.dat),
                  count = nest.counts$nests,
                  beach = nest.counts$ID,
                  yearc = nest.counts$year/(median(min(nest.counts$year):max(nest.counts$year))),
                  X = X,
                  latc = lat.dat$latc,
                  latc2 = lat.dat$latc2)

MCMC.params <- list(n.samples = 100000,
                    n.burnin = 50000,
                    n.thin = 5,
                    n.chains = 5)

parameters <- c("a0", "a1", "beta", "B.hat", "a1pc",
                "delta1", "delta2",
                "floridapc", "probP", "deviance",
                "Devobs", "Devpred")

MCMC.params$model.file = "models/Model_JAGS_rSlope_rInt_3Covs.txt"

if (!file.exists("RData/JAGS_out_Dist_rSlope_rInt.rds")){
  jm <- jags(data = jags.data,
             #inits = inits,
             parameters.to.save= parameters,
             model.file = MCMC.params$model.file,
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, 
             parallel=T)
  
  saveRDS(jm, file = "RData/JAGS_out_Dist_rSlope_rInt.rds")
  
} else {
  jm <- readRDS("RData/JAGS_out_Dist_rSlope_rInt.rds")
}

summary(jm)

mcmc_trace(jm$samples, pars = c("beta[1]", "beta[2]", "beta[3]"))
mcmc_dens(jm$samples, pars = c("beta[1]", "beta[2]", "beta[3]"))
mcmc_trace(jm$samples, pars = c("delta1", "delta2"))
mcmc_dens(jm$samples, pars = c("delta1", "delta2"))

```

These parameters look good but some Rhat stats are too high, according to the output comments. 

```{r}
summary.df <- data.frame(jm$summary) %>% rownames_to_column(var = "parameter") 

summary.df %>% filter(Rhat > 1.01)
```

<<<<<<< HEAD
Something is quite wrong... 

```{r}
summary.df %>% filter(parameter == "a0[1]")
```
=======
Indices 47 and 61 are problematic for a0 and a1. Find out what the problems are... 

>>>>>>> 99abdc45ab004b2dbc1d93696caec6306519ae7e


