---
title: "R Notebook"
output: html_notebook
---

Trend analysis of leatherback turtles nesting in Florida, Puerto Rico, and St Croix with Kelly Stewart.

```{r}
rm(list=ls())
library(tidyverse)
library(ggplot2)
library(readr)
library(lubridate)
library(jagsUI)
library(bayesplot)
```

Get data;

```{r}
col.def <- cols(ID = col_integer(),
                year = col_integer(),
                beach = col_character(),
                latitude = col_double(),
                distance = col_double(),
                days_week = col_integer(),
                days_year = col_integer(),
                nests = col_integer())

nest.counts <- read_csv("data/FL_PR_STX.csv", col_types = col.def) %>% 
  mutate(beach_f = as.factor(toupper(beach)))

```


Try fitting growth models - we can use the same model as the last paper as required/requested by KS. Other state-space models also were fit but the results were not welcomed...  

First, fit the model to the same dataset as the previous paper so that we can be satisfied with the model. 

```{r}

nest.counts %>% select(ID, latitude) %>% 
  group_by(ID) %>%
  summarise(latitude = first(latitude)) %>%
  mutate(latc = latitude - mean(latitude),
         latc2 = latc^2) -> lat.dat 

X <- cbind(nest.counts$distance - median(nest.counts$distance),
           nest.counts$days_week - median(nest.counts$days_week),
           nest.counts$days_year - median(nest.counts$days_year))

# beach ID = 12 is missing from the earlier data... 
nest.counts %>% filter(year < 2009) %>%
  mutate(ID2 = as.numeric(as.factor(ID)))-> nest.counts.2008

nest.counts.2008 %>% select(ID2, latitude) %>% 
  group_by(ID2) %>%
  summarise(latitude = first(latitude)) %>%
  mutate(latc = latitude - mean(latitude),
         latc2 = latc^2) -> lat.dat.2008 

X.2008 <- cbind(nest.counts.2008$distance - median(nest.counts.2008$distance),
                nest.counts.2008$days_week - median(nest.counts.2008$days_week),
                nest.counts.2008$days_year - median(nest.counts.2008$days_year))

MCMC.params <- list(n.samples = 100000,
                    n.burnin = 50000,
                    n.thin = 5,
                    n.chains = 5)

parameters <- c("a0", "a1", "beta", "B.hat", "a1pc",
                "delta1", "delta2",
                "sigma.e", "Sigma.B",
                "sigma.a0", "sigma.a1",
                "floridapc", "probP", "deviance",
                "Devobs", "Devpred")

MCMC.params$model.file = "models/Model_JAGS_rSlope_rInt_3Covs.txt"

jags.data.2008 <- list(N = length(nest.counts.2008$nests),
                       nbeach = length(unique(lat.dat.2008$ID2)),
                       count = nest.counts.2008$nests,
                       beach = nest.counts.2008$ID2,
                       yearc = nest.counts.2008$year/(median(min(nest.counts.2008$year):max(nest.counts.2008$year))),
                       X = X.2008,
                       latc = lat.dat.2008$latc,
                       latc2 = lat.dat.2008$latc2)

if (!file.exists("RData/JAGS_out_Dist_rSlope_rInt_3Covs_2008.rds")){
  jm.2008 <- jags(data = jags.data.2008,
             #inits = inits,
             parameters.to.save= parameters,
             model.file = MCMC.params$model.file,
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, 
             parallel=T)
  
  saveRDS(jm.2008, file = "RData/JAGS_out_Dist_rSlope_rInt_3Covs_2008.rds")
  
} else {
  jm.2008 <- readRDS("RData/JAGS_out_Dist_rSlope_rInt_3Covs_2008.rds")
}

summary(jm.2008)
```

TAke a look at the overdispersion variance parameter.

```{r}
mcmc_dens(jm.2008$samples, pars = "sigma.e")
```

Is this small emough to consider it to be zero? 

Take a look at some parameters to see they are comparable to the published numbers.

```{r}
nest.counts.2008 %>% filter(beach_f == "MIAMI BEACHES") %>% 
  select(ID2) %>% unique() %>% as.vector() -> Miami_Beaches_ID2

jm.2008$summary %>% data.frame() %>%
  rownames_to_column(var = "Parameter") -> estimates.2008

estimates.2008 %>% filter(Parameter == paste0("a1pc[", Miami_Beaches_ID2, "]"))
```

This doesn't look so good. Check the vartiance term

```{r}
estimates.2008 %>% filter(Parameter == "Sigma.B[1,1]")
```

Yes, this is huge!

```{r}
estimates.2008 %>% filter(Parameter == "Sigma.B[2,2]")

```

```{r}
estimates.2008 %>% filter(Parameter == "Sigma.B[1,2]")

```

This explains the problem... so, what went wrong? 




Then use all data:

```{r}
#min(nest.counts$year):max(nest.counts$year)

jags.data <- list(N = length(nest.counts$nests),
                  nbeach = length(unique(lat.dat$ID)),
                  count = nest.counts$nests,
                  beach = nest.counts$ID,
                  yearc = nest.counts$year/(median(min(nest.counts$year):max(nest.counts$year))),
                  X = X,
                  latc = lat.dat$latc,
                  latc2 = lat.dat$latc2)

if (!file.exists("RData/JAGS_out_Dist_rSlope_rInt_3Covs.rds")){
  jm <- jags(data = jags.data,
             #inits = inits,
             parameters.to.save= parameters,
             model.file = MCMC.params$model.file,
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, 
             parallel=T)
  
  saveRDS(jm, file = "RData/JAGS_out_Dist_rSlope_rInt_3Covs.rds")
  
} else {
  jm <- readRDS("RData/JAGS_out_Dist_rSlope_rInt_3Covs.rds")
}

summary(jm)

# mcmc_trace(jm$samples, pars = c("beta[1]", "beta[2]", "beta[3]"))
# mcmc_dens(jm$samples, pars = c("beta[1]", "beta[2]", "beta[3]"))
# mcmc_trace(jm$samples, pars = c("delta1", "delta2"))
# mcmc_dens(jm$samples, pars = c("delta1", "delta2"))

```

TAke a look at the overdispersion variance parameter.

```{r}
mcmc_dens(jm$samples, pars = "sigma.e")
```

It's definitely not zero... 


These parameters look good but some Rhat stats are too high, according to the output comments. 

```{r}
summary.df <- data.frame(jm$summary) %>% rownames_to_column(var = "parameter") 

summary.df %>% filter(Rhat > 1.01)
```


Something is quite wrong... 

```{r}
summary.df %>% filter(parameter == "a0[1]")
```
Indices 47 and 61 are problematic for a0 and a1. Find out what the problems are... 



