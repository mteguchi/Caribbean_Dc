---
title: "R Notebook"
output: html_notebook
---

Trend analysis of leatherback turtles nesting in Florida, Puerto Rico, and St Croix with Kelly Stewart. IN this version (v.2), I use a state-space model that we used for loggerheads/leatherbacks for HI shallow-set longline biological review. The model is similar to ones in Boyd et al. (yr?)

```{r}
rm(list=ls())
library(tidyverse)
library(ggplot2)
library(readr)
library(lubridate)
library(jagsUI)
library(bayesplot)
```

Get data;

```{r}
col.def <- cols(ID = col_integer(),
                year = col_integer(),
                beach = col_character(),
                latitude = col_double(),
                distance = col_double(),
                days_week = col_integer(),
                days_year = col_integer(),
                nests = col_integer())

nest.counts <- read_csv("data/FL_PR_STX.csv", col_types = col.def) %>% 
  mutate(lat_band = ifelse(latitude < 26, 25,
                           ifelse(latitude < 27, 26,
                                  ifelse(latitude < 28, 27,
                                         ifelse(latitude < 29, 28,
                                                ifelse(latitude < 30, 29,
                                                       ifelse(latitude < 31, 30)))))),
         beach_f = as.factor(toupper(beach)))

```

Time series are different lengths. 

```{r}
# There are some skipped years, which needs to be filled in
nest.counts %>% group_by(ID) %>%
  summarise(n.years = max(year) - min(year) + 1,
            year.1 = min(year),
            year.2 = max(year)) -> summary.years

year.mat <- y <- matrix(nrow = nrow(summary.years), 
                        ncol = max(summary.years$n.years))

k <- 3
for (k in 1:nrow(summary.years)){
  nest.counts %>% filter(ID == summary.years$ID[k]) %>%
    select(year, nests) %>% 
    mutate(seq.yr = year - min(year) + 1) -> tmp
  y[k,tmp$seq.yr] <- log(tmp$nests + 1)
  year.mat[k, tmp$seq.yr] <- tmp$year
  
}
```


Try fitting growth models - we can use the same model as the last paper first. 

```{r}
jags.data <- list(n.beaches = nrow(y),
                  n.years = summary.years$n.years,
                  y = y)

MCMC.params <- list(n.samples = 100000,
                    n.burnin = 50000,
                    n.thin = 5,
                    n.chains = 5)

parameters <- c("U", "mean.U", "sigma.U", 
                "sigma.Q", "sigma.R", "loglik")

MCMC.params$model.file = "models/Model_norm_norm_UsQsRs.txt"

if (!file.exists("RData/JAGS_out_norm_norm_UsQsRs.rds")){
  jm <- jags(data = jags.data,
             #inits = inits,
             parameters.to.save= parameters,
             model.file = MCMC.params$model.file,
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, 
             parallel=T)
  
  saveRDS(jm, file = "RData/JAGS_out_norm_norm_UsQsRs.rds")
  
} else {
  jm <- readRDS("RData/JAGS_out_norm_norm_UsQsRs.rds")
}

summary(jm)

mcmc_trace(jm$samples, pars = c("U[1]", "U[2]", "U[3]"))
#mcmc_dens(jm$samples, pars = c("sigma.U"))
# mcmc_trace(jm$samples, pars = c("delta1", "delta2"))
# mcmc_dens(jm$samples, pars = c("delta1", "delta2"))

```

These parameters look good and all Rhat stats are < 1.1.  

```{r}
summary.df <- data.frame(jm$summary) %>% rownames_to_column(var = "parameter") 


```



